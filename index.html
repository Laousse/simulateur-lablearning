<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Simulateur Formation â€” Lab Learning</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">
<style>
:root{
  --g0:#1a3a2a;--g1:#2b4d3f;--g2:#3a6b52;--g3:#4a8a66;
  --acc:#6bc88d;--acc2:#a8e0be;--acc-dim:#eaf6ef;
  --suc:#3a8a5c;--suc-bg:#e4f3ea;--suc-bd:#8fc9a6;
  --warn:#d4a017;--warn-bg:#fdf8e8;
  --err:#c53030;--err-bg:#fde8e8;
  --bg:#f4f6f5;--card:#ffffff;--border:#dce3de;
  --text:#1a2e23;--muted:#5f7368;--light:#eef2ef;
  --r:14px;--r-sm:10px;
  --shadow:0 4px 20px rgba(0,0,0,.06);
  --shadow-lg:0 12px 40px rgba(0,0,0,.1);
  --font-head:'Outfit',sans-serif;
  --font-body:'DM Sans',sans-serif;
  --transition:.3s cubic-bezier(.4,0,.2,1);
}
*{box-sizing:border-box;margin:0;padding:0}
#sim-widget{width:100%;max-width:620px;margin:0 auto;font-family:var(--font-body);color:var(--text);-webkit-font-smoothing:antialiased;}

/* HEADER */
.sw-header{background:linear-gradient(145deg,var(--g0) 0%,var(--g1) 55%,var(--g2) 100%);border-radius:var(--r) var(--r) 0 0;padding:32px 28px 28px;text-align:center;position:relative;overflow:hidden;}
.sw-header::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 60% 70% at 80% -20%,rgba(107,200,141,.12) 0%,transparent 70%);pointer-events:none;}
.sw-logo{height:36px;margin:0 auto 14px;display:block;position:relative;}
.sw-htitle{font-family:var(--font-head);font-size:clamp(18px,4vw,22px);font-weight:800;color:#fff;line-height:1.3;margin-bottom:6px;position:relative;}
.sw-htitle em{color:var(--acc);font-style:normal}
.sw-hsub{font-size:13px;color:rgba(255,255,255,.55);position:relative;line-height:1.5;}

/* PROGRESS */
.sw-progress{display:flex;flex-direction:column;align-items:center;gap:0;padding:18px 20px;background:var(--card);border-bottom:1px solid var(--border);}
.sw-dot{width:10px;height:10px;border-radius:50%;background:var(--border);transition:var(--transition);}
.sw-dot.active{background:var(--g1);transform:scale(1.3);box-shadow:0 0 0 4px rgba(43,77,63,.15);}
.sw-dot.done{background:var(--suc);}
.sw-line{width:32px;height:2px;background:var(--border);transition:var(--transition);margin:0 2px;}
.sw-line.done{background:var(--suc);}
.sw-step-label{font-size:11px;font-weight:700;color:var(--muted);text-align:center;margin-top:10px;letter-spacing:.3px;font-family:var(--font-body);}

/* BODY */
.sw-body{background:var(--card);border-radius:0 0 var(--r) var(--r);box-shadow:var(--shadow);overflow:hidden;min-height:320px;}
.sw-step{display:none;padding:28px 24px 24px;animation:stepIn .4s ease forwards;}
.sw-step.active{display:block}
@keyframes stepIn{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.sw-q{font-family:var(--font-head);font-size:18px;font-weight:700;margin-bottom:4px;display:flex;align-items:center;gap:8px;color:var(--g0);}
.sw-qsub{font-size:13px;color:var(--muted);margin-bottom:20px;line-height:1.55;}

/* Activity cards */
.act-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
@media(min-width:480px){.act-grid{grid-template-columns:repeat(3,1fr)}}
.act-card{padding:18px 12px;border:2px solid var(--border);border-radius:var(--r-sm);cursor:pointer;text-align:center;transition:.2s;background:#fff;}
.act-card:hover{border-color:var(--g2);background:var(--acc-dim);}
.act-card.sel{border-color:var(--g1);background:var(--acc-dim);box-shadow:0 0 0 3px rgba(43,77,63,.1);}
.act-ico{font-size:28px;margin-bottom:6px;}
.act-nm{font-family:var(--font-head);font-size:12px;font-weight:700;line-height:1.3;color:var(--g0);}
.act-op{font-size:9px;color:var(--muted);margin-top:3px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;}

/* Form */
.fg{margin-bottom:14px}
.fl{display:block;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.7px;margin-bottom:6px}
.fi,.fs{width:100%;padding:12px 14px;border:1.5px solid var(--border);border-radius:var(--r-sm);font-family:var(--font-body);font-size:14px;background:#fff;color:var(--text);transition:.15s;}
.fi:focus,.fs:focus{outline:none;border-color:var(--g1);box-shadow:0 0 0 3px rgba(43,77,63,.08)}
.fi.err{border-color:var(--err);background:var(--err-bg)}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:420px){.frow{grid-template-columns:1fr}}

/* Effectif pills */
.eff-pills{display:flex;gap:10px;margin-bottom:18px;}
.eff-pill{flex:1;padding:16px 10px;border:2px solid var(--border);border-radius:var(--r-sm);cursor:pointer;text-align:center;transition:.2s;background:#fff;}
.eff-pill:hover{border-color:var(--g2);}
.eff-pill.sel{border-color:var(--g1);background:var(--acc-dim);}
.eff-pill-val{font-family:var(--font-head);font-size:15px;font-weight:800;color:var(--g1);}
.eff-pill-lbl{font-size:11px;color:var(--muted);margin-top:2px;}
.stepper{display:flex;align-items:center;gap:0;border:1.5px solid var(--border);border-radius:var(--r-sm);overflow:hidden;width:fit-content;}
.stepper-btn{width:44px;height:44px;border:none;background:var(--light);cursor:pointer;font-size:18px;font-weight:700;color:var(--g1);transition:.15s;display:flex;align-items:center;justify-content:center;}
.stepper-btn:hover{background:var(--acc-dim);}
.stepper-val{width:56px;height:44px;text-align:center;border:none;border-left:1px solid var(--border);border-right:1px solid var(--border);font-family:var(--font-head);font-size:18px;font-weight:800;color:var(--text);background:#fff;}
.stepper-val:focus{outline:none;}

/* Section headers (formations) */
.f-section{margin-bottom:6px;margin-top:16px;padding:12px 14px;border-radius:var(--r-sm);display:flex;align-items:center;gap:10px;}
.f-section:first-child{margin-top:0}
.f-section.oblig{background:#fef3e2;border-left:4px solid #e8a020;}
.f-section.renta{background:#e4f3ea;border-left:4px solid var(--suc);}
.f-section-badge{font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.6px;padding:3px 8px;border-radius:4px;white-space:nowrap;}
.f-section-badge.oblig{background:#f5d78e;color:#7a5a0b;}
.f-section-badge.renta{background:#8fc9a6;color:#1a3a2a;}
.f-section-title{font-family:var(--font-head);font-size:13px;font-weight:700;}
.f-section.oblig .f-section-title{color:#7a5a0b}
.f-section.renta .f-section-title{color:#1a3a2a}

/* Formation items */
.f-item{display:flex;align-items:center;gap:12px;padding:12px 14px;border:2px solid var(--border);border-radius:var(--r-sm);margin-bottom:8px;cursor:pointer;transition:.18s;background:#fff;}
.f-item:hover{border-color:var(--g2);}
.f-item.sel{border-color:var(--g1);background:var(--acc-dim);}
.f-chk{width:22px;height:22px;border-radius:6px;border:2px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:.18s;font-size:11px;color:transparent;}
.f-item.sel .f-chk{background:var(--g1);border-color:var(--g1);color:#fff;}
.f-info{flex:1;min-width:0;}
.f-nm{font-weight:600;font-size:13px;line-height:1.3;color:var(--text);}
.f-meta{font-size:11px;color:var(--muted);margin-top:2px;}
.f-dur-toggle{font-size:10px;color:var(--g2);cursor:pointer;text-decoration:underline;display:inline-block;opacity:.75;transition:.15s;}
.f-dur-toggle:hover{opacity:1;color:var(--g1);}
.f-dur-wrap{margin-top:4px;display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
.f-dur-dot{font-size:9px;color:var(--suc);line-height:1;margin-left:2px;}
.f-badge{display:inline-block;font-size:10px;font-weight:700;padding:2px 7px;border-radius:4px;margin-top:3px;}
.f-badge.ok{background:var(--suc-bg);color:#1a5c35}
.f-price{font-family:var(--font-head);font-size:15px;font-weight:800;color:var(--g1);white-space:nowrap;flex-shrink:0;}
.sel-counter{font-size:12px;color:var(--muted);margin-bottom:14px;padding:8px 0;text-align:center;font-weight:600;}
.sel-counter strong{color:var(--g1)}

/* Navigation */
.sw-nav{display:flex;justify-content:space-between;align-items:center;margin-top:22px;gap:10px;padding-top:16px;border-top:1px solid var(--border);}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:13px 24px;border-radius:var(--r-sm);font-family:var(--font-body);font-weight:700;font-size:14px;cursor:pointer;border:none;transition:.2s;}
.btn:hover{transform:translateY(-1px)}.btn:active{transform:none}
.btn-p{background:var(--g1);color:#fff;box-shadow:0 4px 16px rgba(43,77,63,.2);}.btn-p:hover{background:var(--g0);}
.btn-g{background:none;color:var(--muted);font-size:13px;padding:10px 16px;}
.btn-p:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.btn-block{width:100%;}.btn-lg{padding:15px 28px;font-size:15px;}
.btn-loading{pointer-events:none;opacity:.7;}

/* Results */
.res-hero{background:linear-gradient(145deg,var(--g0),var(--g1));border-radius:var(--r-sm);padding:24px;color:#fff;margin-bottom:16px;}
.res-hero h3{font-family:var(--font-head);font-size:17px;font-weight:700;margin-bottom:14px;}
.res-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
@media(max-width:420px){.res-stats{grid-template-columns:repeat(2,1fr)}}
.res-stat{text-align:center;padding:12px 8px;background:rgba(255,255,255,.08);border-radius:8px;}
.res-stat-v{font-family:var(--font-head);font-size:18px;font-weight:800;}
.res-stat-l{font-size:9px;color:rgba(255,255,255,.55);text-transform:uppercase;letter-spacing:.4px;margin-top:2px;font-family:var(--font-body);}
.pec-box{padding:16px;border-radius:var(--r-sm);text-align:center;margin-bottom:16px;border:2px solid;}
.pec-box.ok{background:var(--suc-bg);border-color:var(--suc);}.pec-box.partial{background:var(--warn-bg);border-color:var(--warn);}
.pec-title{font-family:var(--font-head);font-size:15px;font-weight:800;}
.pec-sub{font-size:12px;margin-top:4px;opacity:.8;}.pec-rac{font-family:var(--font-head);font-size:22px;font-weight:800;margin-top:8px;}
.res-table{width:100%;border-collapse:collapse;font-size:12px;margin-bottom:16px;}
.res-table th{padding:8px 10px;text-align:left;font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.4px;color:var(--muted);background:var(--light);border-bottom:2px solid var(--border);}
.res-table td{padding:8px 10px;border-bottom:1px solid #eef2ef;}
.res-table tfoot td{font-weight:700;background:var(--light);border-top:2px solid var(--border);font-size:13px;}
.confirm-card{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--suc-bg);border:1.5px solid var(--suc-bd);border-radius:var(--r-sm);margin-bottom:16px;}
.confirm-ico{width:38px;height:38px;border-radius:50%;background:var(--suc);color:#fff;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.cta-card{background:var(--light);border-radius:var(--r-sm);padding:22px;text-align:center;margin-top:12px;}
.bgt-restant{padding:18px;border-radius:var(--r-sm);text-align:center;margin-bottom:16px;border:2px solid;}
.bgt-restant.alert{background:#fef2f2;border-color:#fca5a5;}
.bgt-restant.bravo{background:var(--suc-bg);border-color:var(--suc-bd);}
.bgt-restant-val{font-family:var(--font-head);font-size:26px;font-weight:800;margin:6px 0;}
.bgt-restant-sub{font-size:12px;margin-top:4px;}

/* Boxes */
.ibox{display:flex;gap:10px;padding:12px 14px;border-radius:var(--r-sm);font-size:12px;line-height:1.5;border:1.5px solid;margin-bottom:14px;}
.ibox.info{background:#eff6ff;border-color:#bfdbfe;color:#1e40af}
.ibox.suc{background:var(--suc-bg);border-color:var(--suc-bd);color:#1a5c35}
.ibox.warn{background:var(--warn-bg);border-color:#e8c94a;color:#6b4e0a}
.ibox.session{background:#fef3e2;border-color:#f5d78e;color:#6b4e0a}
.ibox-i{font-size:16px;flex-shrink:0;line-height:1.4;}
.elig-msg{padding:14px 16px;border-radius:var(--r-sm);font-size:13px;font-weight:700;border:1.5px solid;animation:fadeIn .4s ease;}
.elig-msg.step1{background:var(--suc-bg);border-color:var(--suc-bd);color:#1a5c35}
.elig-msg.step2{background:var(--suc-bg);border-color:var(--suc-bd);color:#1a5c35}
.promise-box{background:linear-gradient(135deg,var(--acc-dim),#fff);border:2px solid var(--suc-bd);border-radius:var(--r-sm);padding:18px 16px;margin-bottom:18px;}
.promise-title{font-family:var(--font-head);font-size:15px;font-weight:700;color:var(--g1);margin-bottom:10px;}
.promise-list{list-style:none;padding:0;}.promise-list li{font-size:12px;padding:5px 0;display:flex;align-items:flex-start;gap:6px;color:var(--text);line-height:1.5;}
.promise-loss{margin-top:10px;padding:10px 12px;background:#fff7ed;border:1.5px solid #fdba74;border-radius:8px;font-size:11px;color:#7c2d12;line-height:1.5;}
.etab-display{display:flex;align-items:center;gap:10px;padding:12px 14px;background:var(--light);border:1.5px dashed var(--border);border-radius:var(--r-sm);margin-bottom:14px;font-size:13px;color:var(--muted);}
.etab-display .etab-ico{color:var(--suc);font-size:16px;}

/* Toast/Confetti */
#sw-toast{position:fixed;top:16px;left:50%;transform:translateX(-50%) translateY(-12px);padding:12px 20px;border-radius:10px;font-weight:700;font-size:13px;z-index:9000;box-shadow:var(--shadow-lg);transition:.3s;opacity:0;pointer-events:none;font-family:var(--font-body);}
#sw-toast.show{transform:translateX(-50%) translateY(0);opacity:1;}
#sw-toast.t-ok{background:var(--suc-bg);color:#1a5c35;border:2px solid var(--suc-bd)}
#sw-toast.t-err{background:var(--err-bg);color:#991b1b;border:2px solid #fca5a5}
@keyframes cDrop{0%{opacity:1;transform:translateY(0) rotate(0)}100%{opacity:0;transform:translateY(120px) rotate(400deg)}}
.c-dot{position:fixed;width:8px;height:8px;border-radius:2px;pointer-events:none;animation:cDrop 1.8s ease forwards;z-index:9999}
.hidden{display:none!important}
.scroll-area{max-height:420px;overflow-y:auto;padding-right:4px;}
.scroll-area::-webkit-scrollbar{width:4px}.scroll-area::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
</style>
</head>
<body style="background:var(--bg);padding:20px 12px;min-height:100vh;">
<div id="sw-toast"></div>
<div id="sim-widget">
  <div class="sw-header">
    <img src="https://image2url.com/r2/default/images/1769773980533-eefb09b4-6364-4787-a446-f57abf702834.png" class="sw-logo" alt="Lab Learning">
    <div class="sw-htitle">Estimez vos formations <em>100% financÃ©es</em></div>
    <div class="sw-hsub">Simulateur gratuit Â· Sans engagement Â· RÃ©sultat en 2 min</div>
  </div>
  <div class="sw-progress" id="swProgress"></div>
  <div class="sw-body">

    <!-- STEP 1 -->
    <div class="sw-step active" id="st1">
      <div class="sw-q">ğŸ¢ Quel est votre secteur ?</div>
      <div class="sw-qsub">SÃ©lectionnez votre activitÃ© pour dÃ©couvrir votre financement disponible.</div>
      <div class="act-grid" id="actGrid"></div>
      <div id="eligMsg1" class="hidden" style="margin-top:14px;"></div>
      <div id="etabBlock" class="hidden" style="margin-top:14px;">
        <div class="fg"><label class="fl">Nom de votre Ã©tablissement</label>
        <input class="fi" type="text" id="s1_etab" placeholder="Ex: Boulangerie Martin" oninput="S.etab=this.value.trim();checkStep1()"></div>
      </div>
      <div class="sw-nav"><div></div><button class="btn btn-p" onclick="next()" id="btn1" disabled>Suivant â†’</button></div>
    </div>

    <!-- STEP 2 -->
    <div class="sw-step" id="st2">
      <div class="sw-q">ğŸ‘¥ Votre entreprise</div>
      <div class="sw-qsub">Indiquez la taille et le nombre de salariÃ©s Ã  former.</div>
      <label class="fl">Effectif total</label>
      <div class="eff-pills">
        <div class="eff-pill sel" onclick="pickEff('<11')"><div class="eff-pill-val">Moins de 11</div><div class="eff-pill-lbl">salariÃ©s</div></div>
        <div class="eff-pill" onclick="pickEff('11-49')"><div class="eff-pill-val">11â€“49</div><div class="eff-pill-lbl">salariÃ©s</div></div>
      </div>
      <label class="fl">SalariÃ©s Ã  former</label>
      <div class="stepper">
        <button class="stepper-btn" onclick="adjNb(-1)">âˆ’</button>
        <input class="stepper-val" type="number" id="s_nb" value="1" min="1" max="49" onchange="const min=S.eff==='11-49'?11:1;S.nb=Math.max(min,Math.min(49,+this.value));this.value=S.nb;updEffWarning()">
        <button class="stepper-btn" onclick="adjNb(1)">+</button>
      </div>
      <div id="effWarning" class="hidden" style="margin-top:10px;">
        <div class="ibox warn" style="margin-bottom:0"><div class="ibox-i">âš ï¸</div><div><strong>Attention :</strong> renseignez bien le nombre de participants Ã  la formation parmi votre effectif total de salariÃ©s.</div></div>
      </div>
      <div style="margin-top:18px;">
        <div class="elig-msg step2">
          <div>âœ… <strong>Votre entreprise bÃ©nÃ©ficie d'un financement OPCO disponible dÃ¨s maintenant.</strong></div>
          <div style="font-size:11px;font-weight:600;margin-top:6px;opacity:.9;">Chaque annÃ©e, des milliers d'euros de budget formation sont dÃ©finitivement perdus par les entreprises qui ne les utilisent pas.</div>
        </div>
      </div>
      <div class="sw-nav">
        <button class="btn btn-g" onclick="prev()">â† Retour</button>
        <button class="btn btn-p" onclick="next()">Voir les formations â†’</button>
      </div>
    </div>

    <!-- STEP 3 -->
    <div class="sw-step" id="st3">
      <div class="sw-q">ğŸ“š Choisissez vos formations</div>
      <div class="sw-qsub">Tarifs pour une intervention sur site, dÃ©placement du formateur inclus.</div>
      <div id="selCounter" class="sel-counter"></div>
      <div id="sessionMsg" class="hidden"></div>
      <div class="scroll-area" id="fList"></div>
      <div class="sw-nav">
        <button class="btn btn-g" onclick="prev()">â† Retour</button>
        <button class="btn btn-p" onclick="next()" id="btn3" disabled>Obtenir mon analyse personnalisÃ©e â†’</button>
      </div>
    </div>

    <!-- STEP 4 -->
    <div class="sw-step" id="st4">
      <div class="sw-q">ğŸ¯ Votre simulation est prÃªte.</div>
      <div class="sw-qsub">Renseignez vos coordonnÃ©es pour recevoir votre analyse dÃ©taillÃ©e par email.</div>
      <div class="promise-box">
        <div class="promise-title">ğŸ“© Voici ce que vous allez recevoir :</div>
        <ul class="promise-list">
          <li><span>âœ…</span> Le montant exact de votre <strong>budget OPCO disponible</strong></li>
          <li><span>âœ…</span> Le dÃ©tail du <strong>financement par formation</strong> sÃ©lectionnÃ©e</li>
          <li><span>âœ…</span> Votre <strong>reste Ã  charge estimÃ©</strong> (souvent 0 â‚¬)</li>
          <li><span>âœ…</span> Le budget que vous <strong>perdrez en fin d'annÃ©e <span id="expiryYearPromise"></span></strong> si vous ne l'utilisez pas</li>
        </ul>
        <div class="promise-loss">â³ Ce budget est <strong>dÃ©jÃ  prÃ©levÃ© sur vos cotisations</strong>. Ne pas l'utiliser, c'est le perdre dÃ©finitivement.</div>
      </div>
      <div class="frow">
        <div class="fg"><label class="fl">CivilitÃ©</label><select class="fs" id="c_civ"><option value="">â€”</option><option value="M.">M.</option><option value="Mme">Mme</option></select></div>
        <div class="fg"><label class="fl">PrÃ©nom</label><input class="fi" type="text" id="c_pre" placeholder="PrÃ©nom"></div>
      </div>
      <div class="fg"><label class="fl">Nom</label><input class="fi" type="text" id="c_nom" placeholder="Nom de famille"></div>
      <div class="fg"><label class="fl">Email</label><input class="fi" type="email" id="c_email" placeholder="votre@email.fr"></div>
      <div class="fg"><label class="fl">TÃ©lÃ©phone</label><input class="fi" type="tel" id="c_phone" placeholder="06 12 34 56 78"></div>
      <div class="etab-display"><span class="etab-ico">âœ…</span><span>Ã‰tablissement : <strong id="etabPreview">â€”</strong></span></div>
      <div class="ibox info"><div class="ibox-i">ğŸ”’</div><div>Vos donnÃ©es sont confidentielles et utilisÃ©es uniquement pour vous transmettre votre estimation et vous proposer un Ã©change avec un conseiller Lab Learning. Aucune revente, aucune sollicitation non souhaitÃ©e.</div></div>
      <div class="sw-nav">
        <button class="btn btn-g" onclick="prev()">â† Retour</button>
        <button class="btn btn-p btn-lg btn-block" onclick="submitForm()" id="btnSubmit">Recevoir mon analyse complÃ¨te par email</button>
      </div>
    </div>

    <!-- STEP 5 -->
    <div class="sw-step" id="st5">
      <div id="confirmBox"></div>
      <div id="resHero"></div>
      <div id="resPEC"></div>
      <div id="resTable"></div>
      <div id="resBgtRestant"></div>
      <div class="ibox warn"><div class="ibox-i">âš ï¸</div><div>Estimation indicative. Les montants dÃ©finitifs seront confirmÃ©s lors de votre Ã©change avec notre conseiller.</div></div>
      <div class="cta-card">
        <div style="font-size:28px;margin-bottom:8px;">ğŸ“</div>
        <div style="font-family:var(--font-head);font-size:15px;font-weight:700;margin-bottom:4px;color:var(--g1);">Un conseiller vous rappelle sous 24h</div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:14px;">Du lundi au vendredi, 9hâ€“18h. Gratuit et sans engagement.</div>
        <a href="tel:+33626835580" class="btn btn-p">06 26 83 55 80</a>
      </div>
      <div style="text-align:center;margin-top:16px;"><button class="btn btn-g" onclick="restart()">ğŸ”„ Nouvelle simulation</button></div>
    </div>

  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG (verified vs v6)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CFG={
  hcr:{label:"HCR (HÃ´tellerie-Restauration)",opco:"AKTO",idcc:1979,dayRate:1000,plafond:{"<11":2000,"11-49":3000},icon:"ğŸ½ï¸"},
  restauration_rapide:{label:"Restauration rapide",opco:"AKTO",idcc:1501,rdef:25,dayCap:1200,plafond:{"<11":4000,"11-49":9000},icon:"ğŸ”"},
  boucherie:{label:"Boucherie / Charcuterie",opco:"OPCO EP",idcc:992,plafond:{"<11":5000,"11-49":5000},icon:"ğŸ¥©",
    cats:[{id:"bc-tech",r:60},{id:"bc-trac",r:50},{id:"bc-hyg",r:50},{id:"bc-pms",r:50},{id:"bc-mgt",r:25},{id:"bc-ges",r:25}]},
  boulangerie:{label:"Boulangerie artisanale",opco:"OPCO EP",idcc:843,plafond:{default:3500},icon:"ğŸ¥–",
    cats:[{id:"bl-fab",r:50},{id:"bl-ven",r:40},{id:"bl-ges",r:40},{id:"bl-hyg",r:30},{id:"bl-eco",r:40},{id:"bl-soc",r:25}]},
  patisserie:{label:"PÃ¢tisserie artisanale",opco:"OPCO EP",idcc:1267,plafond:{"<11":2000,"11-49":3000},icon:"ğŸ°",
    cats:[{id:"pt-fab",r:50},{id:"pt-hyg",r:30},{id:"pt-eti",r:50},{id:"pt-dec",r:50},{id:"pt-ven",r:50},{id:"pt-acc",r:30},{id:"pt-ges",r:30},{id:"pt-mgt",r:30},{id:"pt-info",r:30}]}
};
const CATA={
hcr:[
  {id:"hcr-1",nm:"HygiÃ¨ne alimentaire et prÃ©vention des risques",hOpt:[14,21],cat:"hygiene",grp:"conformite",pri:1},
  {id:"hcr-3",nm:"DUERP â€“ Ã‰laboration et mise Ã  jour",h:7,cat:"reglementaire",grp:"conformite",pri:2},
  {id:"hcr-4",nm:"SÃ©curitÃ© incendie et Ã©vacuation",h:3.5,cat:"reglementaire",grp:"conformite",pri:2},
  {id:"hcr-5",nm:"Gestes et postures â€“ PrÃ©vention des TMS",h:7,cat:"reglementaire",grp:"conformite",pri:2},
  {id:"hcr-6",nm:"SST â€“ Sauveteur Secouriste du Travail (initiale)",h:14,cat:"reglementaire",grp:"conformite",pri:2},
  {id:"hcr-7",nm:"Management de proximitÃ© en restauration",h:14,cat:"management",grp:"competence",pri:3},
  {id:"hcr-8",nm:"Organisation du service et gestion du rush",h:7,cat:"metier",grp:"competence",pri:1},
  {id:"hcr-9",nm:"Gestion des stocks et rentabilitÃ©",h:14,cat:"performance",grp:"competence",pri:3},
  {id:"hcr-10",nm:"Excellence du service client en restauration",h:21,cat:"performance",grp:"competence",pri:1},
  {id:"hcr-11",nm:"Gestion du stress et des conflits",h:14,cat:"transverse",grp:"competence",pri:4},
  {id:"hcr-12",nm:"Anglais professionnel en restauration",h:14,cat:"transverse",grp:"competence",pri:4},
  {id:"hcr-13",nm:"Respecter le cadre lÃ©gal d'une activitÃ© de restauration",h:7,cat:"reglementaire",grp:"conformite",pri:2},
  {id:"hcr-14",nm:"IA simplifiÃ©e pour la restauration",h:14,cat:"performance",grp:"competence",pri:3},
  {id:"hcr-15",nm:"Techniques culinaires (Restauration classique)",h:14,cat:"metier",grp:"competence",pri:1}
],
restauration_rapide:[
  {id:"rr-1",nm:"HygiÃ¨ne alimentaire et prÃ©vention des risques",hOpt:[14,21],cat:"hygiene",grp:"conformite",pri:1},
  {id:"rr-3",nm:"SST â€“ Sauveteur Secouriste du Travail (initiale)",h:14,cat:"reglementaire",grp:"conformite",pri:2},
  {id:"rr-4",nm:"Techniques culinaires en restauration rapide",h:7,cat:"metier",grp:"competence",pri:1},
  {id:"rr-5",nm:"Ã‰laboration et mise Ã  jour du DUERP",h:7,cat:"reglementaire",grp:"conformite",pri:2},
  {id:"rr-6",nm:"IA simplifiÃ©e pour les Ã©quipes de fast-food",h:14,cat:"performance",grp:"competence",pri:3},
  {id:"rr-7",nm:"Gestes & postures â€“ PrÃ©vention des TMS",h:7,cat:"reglementaire",grp:"conformite",pri:2},
  {id:"rr-8",nm:"Organisation & management en service",h:14,cat:"management",grp:"competence",pri:3},
  {id:"rr-9",nm:"Gestion des stocks & rentabilitÃ©",h:14,cat:"performance",grp:"competence",pri:3},
  {id:"rr-10",nm:"QualitÃ© de service, vente additionnelle & rÃ©clamations",h:7,cat:"performance",grp:"competence",pri:3},
  {id:"rr-11",nm:"Outils digitaux & IA pour optimiser la restauration rapide",h:7,cat:"performance",grp:"competence",pri:4},
  {id:"rr-12",nm:"Respecter le cadre lÃ©gal d'une activitÃ© de restauration rapide",h:7,cat:"reglementaire",grp:"conformite",pri:2},
  {id:"rr-13",nm:"SÃ©curitÃ© incendie et Ã©vacuation",h:4,cat:"reglementaire",grp:"conformite",pri:2}
],
boucherie:[
  {id:"bo-1",nm:"DÃ©coupe, dÃ©sossage & parage",hOpt:[7,14,21],cat:"metier",fc:"bc-tech",grp:"competence",pri:1},
  {id:"bo-2",nm:"PrÃ©parations bouchÃ¨res & traiteur",hOpt:[7,14,21],cat:"metier",fc:"bc-tech",grp:"competence",pri:1},
  {id:"bo-3",nm:"Organisation du laboratoire & flux",hOpt:[7,14,21],cat:"metier",fc:"bc-tech",grp:"competence",pri:1},
  {id:"bo-4",nm:"Techniques de charcuterie artisanale",hOpt:[7,14,21],cat:"metier",fc:"bc-tech",grp:"competence",pri:1},
  {id:"bo-5",nm:"HygiÃ¨ne alimentaire en boucherie (HACCP & PMS)",hOpt:[7,14,21],cat:"hygiene",fc:"bc-pms",grp:"conformite",pri:2},
  {id:"bo-6",nm:"Plan de nettoyage-dÃ©sinfection (PND)",hOpt:[7,14,21],cat:"hygiene",fc:"bc-hyg",grp:"conformite",pri:2},
  {id:"bo-7",nm:"ChaÃ®ne du froid & maÃ®trise des risques",hOpt:[7,14,21],cat:"hygiene",fc:"bc-hyg",grp:"conformite",pri:2},
  {id:"bo-8",nm:"TraÃ§abilitÃ©, lots, DLC & retrait/rappel",hOpt:[7,14,21],cat:"reglementaire",fc:"bc-trac",grp:"conformite",pri:2},
  {id:"bo-9",nm:"Ã‰tiquetage, allergÃ¨nes & INCO",hOpt:[7,14,21],cat:"reglementaire",fc:"bc-trac",grp:"conformite",pri:2},
  {id:"bo-10",nm:"SÃ©curitÃ© au poste : couteaux, scie, hachoir",hOpt:[7,14,21],cat:"reglementaire",fc:"bc-tech",grp:"conformite",pri:2},
  {id:"bo-11",nm:"Gestes et postures â€“ TMS en boucherie",hOpt:[7,14,21],cat:"reglementaire",fc:"bc-hyg",grp:"conformite",pri:2},
  {id:"bo-13",nm:"Vente-conseil au comptoir",hOpt:[7,14,21],cat:"performance",fc:"bc-ges",grp:"competence",pri:3},
  {id:"bo-14",nm:"Merchandising vitrine & animation commerciale",hOpt:[7,14,21],cat:"performance",fc:"bc-ges",grp:"competence",pri:3},
  {id:"bo-15",nm:"Gestion des stocks & inventaires",hOpt:[7,14,21],cat:"performance",fc:"bc-ges",grp:"competence",pri:3},
  {id:"bo-16",nm:"Pilotage d'activitÃ© : marge, rendement, pricing",hOpt:[7,14,21],cat:"performance",fc:"bc-ges",grp:"competence",pri:3},
  {id:"bo-17",nm:"Management d'Ã©quipe & intÃ©gration",hOpt:[7,14,21],cat:"management",fc:"bc-mgt",grp:"competence",pri:3},
  {id:"bo-18",nm:"SST + MAC SST",hOpt:[14,7],cat:"reglementaire",fc:"bc-hyg",grp:"conformite",pri:2}
],
boulangerie:[
  {id:"bl-1",nm:"HygiÃ¨ne et Bonnes Pratiques Professionnelles",h:7,cat:"hygiene",fc:"bl-hyg",grp:"conformite",pri:2},
  {id:"bl-2",nm:"TraÃ§abilitÃ© et Gestion des Produits",h:7,cat:"reglementaire",fc:"bl-hyg",grp:"conformite",pri:2},
  {id:"bl-3",nm:"PrÃ©vention des Risques Professionnels",h:7,cat:"reglementaire",fc:"bl-hyg",grp:"competence",pri:2},
  {id:"bl-4",nm:"Techniques de Vente en Boulangerie",h:7,cat:"performance",fc:"bl-ven",grp:"competence",pri:3},
  {id:"bl-5",nm:"PrÃ©sentation des Produits & Merchandising",h:7,cat:"performance",fc:"bl-ven",grp:"competence",pri:3},
  {id:"bl-6",nm:"Connaissance des Produits en Boulangerie",h:7,cat:"metier",fc:"bl-fab",grp:"competence",pri:1},
  {id:"bl-7",nm:"Transition Ã‰cologique en Boulangerie",h:14,cat:"transverse",fc:"bl-eco",grp:"competence",pri:4},
  {id:"bl-8",nm:"Management d'Ã©quipe en Boulangerie",h:14,cat:"management",fc:"bl-soc",grp:"competence",pri:3},
  {id:"bl-9",nm:"ComptabilitÃ©, Gestion et RentabilitÃ©",h:14,cat:"performance",fc:"bl-ges",grp:"competence",pri:3}
],
patisserie:[
  {id:"pa-1",nm:"Techniques de fabrication / prÃ©paration / transformation",hOpt:[7,14,21],cat:"metier",fc:"pt-fab",grp:"competence",pri:1},
  {id:"pa-2",nm:"HygiÃ¨ne & SÃ©curitÃ© alimentaire",hOpt:[7,14,21],cat:"hygiene",fc:"pt-hyg",grp:"conformite",pri:2},
  {id:"pa-3",nm:"TraÃ§abilitÃ© & Ã©tiquetage",h:7,cat:"reglementaire",fc:"pt-eti",grp:"conformite",pri:2},
  {id:"pa-4",nm:"Magasinage / dÃ©coration vitrine",h:7,cat:"performance",fc:"pt-dec",grp:"competence",pri:3},
  {id:"pa-5",nm:"Label qualitÃ© / innovation",h:7,cat:"metier",fc:"pt-fab",grp:"competence",pri:3},
  {id:"pa-6",nm:"Techniques de vente",h:7,cat:"performance",fc:"pt-ven",grp:"competence",pri:3},
  {id:"pa-7",nm:"Pilotage d'entreprise",h:7,cat:"performance",fc:"pt-ges",grp:"competence",pri:3},
  {id:"pa-8",nm:"Management",h:7,cat:"management",fc:"pt-mgt",grp:"competence",pri:3},
  {id:"pa-9",nm:"Accueil / Communication",h:7,cat:"performance",fc:"pt-acc",grp:"competence",pri:3},
  {id:"pa-10",nm:"Informatique / RÃ©seaux sociaux",h:7,cat:"transverse",fc:"pt-info",grp:"competence",pri:4},
  {id:"pa-11",nm:"Bureautique / ComptabilitÃ©",h:7,cat:"transverse",fc:"pt-info",grp:"competence",pri:4},
  {id:"pa-12",nm:"Secourisme",h:7,cat:"reglementaire",fc:"pt-hyg",grp:"conformite",pri:2}
]};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let S={act:null,eff:'<11',nb:1,sel:new Set(),etab:'',durOverride:{}};
let step=1;
const STEPS=['Secteur','Entreprise','Formations','CoordonnÃ©es','RÃ©sultat'];
const BREVO_KEY='';// ClÃ© supprimÃ©e â€” sÃ©curisÃ©e cÃ´tÃ© serveur via Cloudflare Worker
const SENDER={name:"Lab Learning",email:"laoussine.tatah@lab-learning.fr"};
// â¬‡ï¸ REMPLACE PAR L'URL DE TON CLOUDFLARE WORKER (ex: https://brevo-proxy.ton-compte.workers.dev)
const EMAIL_PROXY='https://brevo-proxy.laoussine-tatah.workers.dev';
const EXPIRY_YEAR=new Date().getFullYear();
const EXPIRY_DATE=`fin d'annÃ©e ${EXPIRY_YEAR}`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const fmt=n=>new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',minimumFractionDigits:0,maximumFractionDigits:0}).format(n);
const fmtN=n=>new Intl.NumberFormat('fr-FR').format(Math.round(n));
const gv=id=>document.getElementById(id)?.value?.trim()||'';
function getPlaf(act,tr){const c=CFG[act];if(!c)return 0;if(c.plafond[tr]!==undefined)return c.plafond[tr];return c.plafond.default||c.plafond['<11']||0;}
function getRate(f,act){if(act==='hcr')return CFG.hcr.dayRate||1000;if(act==='restauration_rapide')return CFG.restauration_rapide.rdef||35;const c=CFG[act];if(!c)return 0;if(f.fc){const cat=c.cats?.find(x=>x.id===f.fc);if(cat)return cat.r;}return 0;}

// Smart default duration for hygiene formations
function getDefaultH(f,act){
  // HCR hygiene: default 14h (2j â€” optimal for forfait jour)
  if(act==='hcr'&&f.hOpt&&f.cat==='hygiene') return 14;
  // RR hygiene: default 21h (3j â€” optimal for taux horaire)
  if(act==='restauration_rapide'&&f.hOpt&&f.cat==='hygiene') return 21;
  return f.hOpt?f.hOpt[0]:f.h||7;
}
function isHygieneToggleable(f,act){
  return f.hOpt&&f.cat==='hygiene'&&(act==='hcr'||act==='restauration_rapide');
}
function getH(f){
  const override=S.durOverride[f.id];
  if(override) return override;
  return getDefaultH(f,S.act);
}
function getCost(f,h,act,nb){
  if(act==='hcr') return Math.ceil(h/7)*(CFG.hcr.dayRate||1000);
  if(act==='restauration_rapide'){
    const days=Math.ceil(h/7);
    const hPerDay=h/days;
    const rawPerDay=hPerDay*CFG.restauration_rapide.rdef*nb;
    const capPerDay=Math.min(rawPerDay,CFG.restauration_rapide.dayCap);
    return capPerDay*days;
  }
  return h*getRate(f,act)*nb;
}
function getTotalCost(){let t=0;S.sel.forEach(id=>{const f=(CATA[S.act]||[]).find(x=>x.id===id);if(f)t+=getCost(f,getH(f),S.act,S.nb);});return t;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROGRESS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderProg(){let h='<div style="display:flex;align-items:center;justify-content:center;gap:0;">';STEPS.forEach((_,i)=>{const n=i+1;if(i>0)h+=`<div class="sw-line ${n<=step?'done':''}"></div>`;h+=`<div class="sw-dot ${n===step?'active':''} ${n<step?'done':''}"></div>`;});h+=`</div><div class="sw-step-label">${STEPS[step-1]} â€” Ã‰tape ${step}/${STEPS.length}</div>`;document.getElementById('swProgress').innerHTML=h;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goTo(n){step=n;for(let i=1;i<=5;i++)document.getElementById('st'+i).classList.toggle('active',i===n);renderProg();document.getElementById('sim-widget').scrollIntoView({behavior:'smooth',block:'start'});}
function next(){
  if(step===1){if(!S.act||!S.etab){toast('SÃ©lectionnez votre secteur et renseignez votre Ã©tablissement','err');return;}goTo(2);}
  else if(step===2){goTo(3);renderFormations();}
  else if(step===3){if(S.sel.size===0){toast('SÃ©lectionnez au moins une formation','err');return;}goTo(4);prepStep4();}
  else if(step===4){submitForm();}
}
function prev(){
  if(step===3){
    // Going back to step 2 â€” formations will re-render on next()
    goTo(2);
  } else if(step===4){
    // Going back to step 3 â€” re-render with current S.nb (may have changed)
    goTo(3);renderFormations();
  } else {
    goTo(step-1);
  }
}
function restart(){
  // Full state reset
  S={act:null,eff:'<11',nb:1,sel:new Set(),etab:'',durOverride:{}};
  // Reset step 1
  document.getElementById('s1_etab').value='';
  document.getElementById('eligMsg1').classList.add('hidden');
  document.getElementById('eligMsg1').innerHTML='';
  document.getElementById('etabBlock').classList.add('hidden');
  document.getElementById('btn1').disabled=true;
  // Reset step 2
  document.getElementById('s_nb').value=1;
  document.querySelectorAll('.eff-pill').forEach((el,i)=>el.classList.toggle('sel',i===0));
  document.getElementById('effWarning').classList.add('hidden');
  // Reset step 3
  document.getElementById('fList').innerHTML='';
  document.getElementById('selCounter').innerHTML='';
  document.getElementById('sessionMsg').classList.add('hidden');
  document.getElementById('sessionMsg').innerHTML='';
  document.getElementById('btn3').disabled=true;
  // Reset step 4
  ['c_civ','c_pre','c_nom','c_email','c_phone'].forEach(id=>{const el=document.getElementById(id);if(el){el.value='';el.classList.remove('err');}});
  document.getElementById('etabPreview').textContent='â€”';
  const btn=document.getElementById('btnSubmit');btn.classList.remove('btn-loading');btn.textContent='Recevoir mon analyse complÃ¨te par email';
  // Reset step 5
  ['confirmBox','resHero','resPEC','resTable','resBgtRestant'].forEach(id=>{document.getElementById(id).innerHTML='';});
  // Go to step 1
  goTo(1);
  renderActGrid();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 1
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderActGrid(){let h='';for(const[k,c]of Object.entries(CFG)){h+=`<div class="act-card ${S.act===k?'sel':''}" onclick="pickAct('${k}')"><div class="act-ico">${c.icon}</div><div class="act-nm">${c.label.split('(')[0].split('â€”')[0].trim()}</div><div class="act-op">OPCO ${c.opco}</div></div>`;}document.getElementById('actGrid').innerHTML=h;}
function pickAct(k){S.act=k;S.sel=new Set();S.durOverride={};document.querySelectorAll('.act-card').forEach(el=>el.classList.remove('sel'));event.currentTarget.classList.add('sel');document.getElementById('eligMsg1').classList.remove('hidden');document.getElementById('eligMsg1').innerHTML=`<div class="elig-msg step1">âœ… <strong>Votre secteur est Ã©ligible Ã  un financement OPCO</strong></div>`;document.getElementById('etabBlock').classList.remove('hidden');document.getElementById('s1_etab').focus();checkStep1();}
function checkStep1(){document.getElementById('btn1').disabled=!(S.act&&S.etab);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 2
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pickEff(v){S.eff=v;document.querySelectorAll('.eff-pill').forEach(el=>el.classList.remove('sel'));event.currentTarget.classList.add('sel');const inp=document.getElementById('s_nb');if(v==='11-49'&&S.nb<11){S.nb=11;inp.value=11;}if(v==='<11'&&S.nb>10){S.nb=1;inp.value=1;}updEffWarning();}
function adjNb(d){const inp=document.getElementById('s_nb');const min=S.eff==='11-49'?11:1;S.nb=Math.max(min,Math.min(49,(+inp.value)+d));inp.value=S.nb;updEffWarning();}
function updEffWarning(){document.getElementById('effWarning').classList.toggle('hidden',S.eff!=='11-49');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 3 â€” FORMATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFormations(){
  const act=S.act,nb=S.nb,catalog=CATA[act]||[];
  const sorted=[...catalog].sort((a,b)=>a.grp===b.grp?a.pri-b.pri:a.grp==='conformite'?-1:1);
  let html='',lastGrp='';
  sorted.forEach(f=>{
    const h=getH(f),cost=getCost(f,h,act,nb),days=Math.ceil(h/7);
    if(f.grp!==lastGrp){
      lastGrp=f.grp;
      if(f.grp==='conformite') html+=`<div class="f-section oblig"><span class="f-section-badge oblig">Obligatoire</span><span class="f-section-title">Formations obligatoires</span></div>`;
      else html+=`<div class="f-section renta"><span class="f-section-badge renta">RentabilitÃ©</span><span class="f-section-title">RentabilitÃ© & compÃ©tences</span></div>`;
    }
    const isSel=S.sel.has(f.id);
    // Duration toggle for hygiene formations (HCR/RR)
    let durToggle='';
    if(isSel&&isHygieneToggleable(f,act)){
      const defaultH=getDefaultH(f,act);
      const curH=h;
      const isAlt=curH!==defaultH;
      const altH=isAlt?defaultH:(defaultH===14?21:14);
      const altDays=Math.ceil(altH/7);
      const curDays=Math.ceil(curH/7);
      durToggle=`<div class="f-dur-wrap">
        <span class="f-dur-toggle" onclick="event.stopPropagation();switchDur('${f.id}',${isAlt?0:altH})">${isAlt?'Revenir sur '+Math.ceil(defaultH/7)+' jours':'Passer sur '+altDays+' jour'+(altDays>1?'s':'')}</span>${isAlt?'<span class="f-dur-dot">â—</span>':''}
      </div>`;
    }
    html+=`<div class="f-item ${isSel?'sel':''}" onclick="togF('${f.id}')" id="fi_${f.id}">
      <div class="f-chk">âœ“</div>
      <div class="f-info">
        <div class="f-nm">${f.nm}</div>
        <div class="f-meta">${days} jour${days>1?'s':''}</div>
        ${isSel?durToggle:''}
        <div class="f-badge-slot" id="fb_${f.id}"></div>
      </div>
      <div class="f-price" id="fp_${f.id}">${fmt(cost)}</div>
    </div>`;
  });
  document.getElementById('fList').innerHTML=html;
  updCoverage();
}
function switchDur(fid,newH){
  if(newH===0) delete S.durOverride[fid];
  else S.durOverride[fid]=newH;
  renderFormations();
}
function togF(id){
  if(S.sel.has(id)){S.sel.delete(id);delete S.durOverride[id];}
  else S.sel.add(id);
  renderFormations();
  document.getElementById('btn3').disabled=S.sel.size===0;
}
function updCoverage(){
  const used=getTotalCost(),opcoName=CFG[S.act]?.opco||'OPCO';
  if(S.sel.size>0) document.getElementById('selCounter').innerHTML=`Vous avez sÃ©lectionnÃ© <strong>${S.sel.size} formation${S.sel.size>1?'s':''}</strong> Â· Total : <strong>${fmt(used)}</strong> potentiellement financÃ©s`;
  else document.getElementById('selCounter').innerHTML='';

  // Session split message for 8+ participants (HCR & RR)
  const sessionEl=document.getElementById('sessionMsg');
  if(S.sel.size>0&&S.nb>=7&&(S.act==='hcr'||S.act==='restauration_rapide')){
    sessionEl.classList.remove('hidden');
    sessionEl.innerHTML=`<div class="ibox session"><div class="ibox-i">ğŸ‘¥</div><div><strong>${S.nb} participants</strong> â€” Pour garantir la qualitÃ© de la formation et son bon dÃ©roulement, celle-ci pourra Ãªtre organisÃ©e en plusieurs sessions. Votre conseiller vous prÃ©cisera l'organisation lors de votre Ã©change.</div></div>`;
  } else {
    sessionEl.classList.add('hidden');
    sessionEl.innerHTML='';
  }

  S.sel.forEach(id=>{const slot=document.getElementById('fb_'+id);if(slot) slot.innerHTML=`<div class="f-badge ok">âœ… Potentiellement finanÃ§able via votre ${opcoName}</div>`;});
  (CATA[S.act]||[]).forEach(f=>{if(!S.sel.has(f.id)){const slot=document.getElementById('fb_'+f.id);if(slot)slot.innerHTML='';}});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 4
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function prepStep4(){document.getElementById('etabPreview').textContent=S.etab||'â€”';document.getElementById('expiryYearPromise').textContent=EXPIRY_YEAR;}
function validateContact(){let ok=true;['c_civ','c_pre','c_nom','c_email','c_phone'].forEach(id=>{document.getElementById(id)?.classList.remove('err');});if(!gv('c_civ')){document.getElementById('c_civ').classList.add('err');ok=false;}if(!gv('c_pre')){document.getElementById('c_pre').classList.add('err');ok=false;}if(!gv('c_nom')){document.getElementById('c_nom').classList.add('err');ok=false;}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(gv('c_email'))){document.getElementById('c_email').classList.add('err');ok=false;}if(gv('c_phone').replace(/\s/g,'').length<10){document.getElementById('c_phone').classList.add('err');ok=false;}if(!ok)toast('Veuillez remplir tous les champs','err');return ok;}
function submitForm(){if(!validateContact())return;const btn=document.getElementById('btnSubmit');btn.classList.add('btn-loading');btn.textContent='Envoi en cours...';goTo(5);showResults();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 5 â€” RESULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showResults(){
  const act=S.act,nb=S.nb,opco=getPlaf(act,S.eff),catalog=CATA[act]||[];
  const opcoName=CFG[act]?.opco||'OPCO';
  let totalH=0,totalJ=0,totalCost=0;const rows=[];
  S.sel.forEach(id=>{const f=catalog.find(x=>x.id===id);if(!f)return;const h=getH(f),cost=getCost(f,h,act,nb);totalH+=h;totalJ+=Math.ceil(h/7);totalCost+=cost;rows.push({f,h,cost});});
  const finOpco=Math.min(totalCost,opco),rac=Math.max(0,totalCost-opco),budgetRestant=Math.max(0,opco-totalCost);
  const pre=gv('c_pre'),nom=gv('c_nom'),email=gv('c_email');

  document.getElementById('confirmBox').innerHTML=`<div class="confirm-card"><div class="confirm-ico">ğŸ“§</div><div><div style="font-weight:700;font-size:13px;">Votre analyse a Ã©tÃ© envoyÃ©e sur ${email}</div><div style="font-size:11px;color:var(--muted)">Un conseiller Lab Learning vous contacte sous 24h</div></div></div>`;

  document.getElementById('resHero').innerHTML=`<div class="res-hero"><h3>ğŸ‰ Votre analyse personnalisÃ©e</h3><div class="res-stats">
    <div class="res-stat"><div class="res-stat-v">${S.sel.size}</div><div class="res-stat-l">Formations</div></div>
    <div class="res-stat"><div class="res-stat-v">${totalH}h</div><div class="res-stat-l">Heures</div></div>
    <div class="res-stat"><div class="res-stat-v">${fmt(totalCost)}</div><div class="res-stat-l">Total</div></div>
    <div class="res-stat"><div class="res-stat-v" style="color:var(--acc)">${fmt(finOpco)}</div><div class="res-stat-l">Pris en charge</div></div>
    <div class="res-stat"><div class="res-stat-v" style="color:${rac===0?'var(--acc)':'#e8a020'}">${fmt(rac)}</div><div class="res-stat-l">Reste Ã  charge</div></div>
    <div class="res-stat"><div class="res-stat-v">${totalJ}j</div><div class="res-stat-l">Jours</div></div>
  </div></div>`;

  document.getElementById('resPEC').innerHTML=rac===0
    ?`<div class="pec-box ok"><div class="pec-title" style="color:#1a5c35">âœ… Prise en charge potentielle Ã  100%</div><div class="pec-sub" style="color:#1a5c35">FinancÃ© intÃ©gralement par ${opcoName}</div><div class="pec-rac" style="color:var(--g1)">0 â‚¬ de reste Ã  charge</div></div>`
    :`<div class="pec-box partial"><div class="pec-title" style="color:#7a5a0b">âš ï¸ DÃ©passement de ${fmt(rac)}</div><div class="pec-sub" style="color:#6b4e0a">Budget ${opcoName}: ${fmt(opco)} â€” Total: ${fmt(totalCost)}</div><div class="pec-rac" style="color:var(--err)">Reste Ã  charge : ${fmt(rac)}</div></div>`;

  // Table with Total formations line BEFORE budget lines
  let tH=`<table class="res-table"><thead><tr><th>Formation</th><th>DurÃ©e</th><th style="text-align:right">Montant</th></tr></thead><tbody>`;
  rows.forEach(({f,h,cost})=>{tH+=`<tr><td>${f.nm}</td><td>${h}h</td><td style="text-align:right;font-weight:700">${fmt(cost)}</td></tr>`;});
  tH+=`</tbody><tfoot>`;
  tH+=`<tr><td><strong>Total formations</strong></td><td>${totalH}h</td><td style="text-align:right;font-weight:800;font-size:14px">${fmt(totalCost)}</td></tr>`;
  tH+=`<tr><td>Budget ${opcoName} disponible</td><td></td><td style="text-align:right;color:var(--g1);font-weight:700">${fmt(opco)}</td></tr>`;
  if(rac>0)tH+=`<tr><td>Reste Ã  charge</td><td></td><td style="text-align:right;color:var(--err);font-weight:700">${fmt(rac)}</td></tr>`;
  tH+=`</tfoot></table>`;
  document.getElementById('resTable').innerHTML=tH;

  if(budgetRestant>0){
    document.getElementById('resBgtRestant').innerHTML=`<div class="bgt-restant alert"><div style="font-size:13px;font-weight:700;color:#991b1b">âš ï¸ Il vous reste du budget OPCO non mobilisÃ©</div><div class="bgt-restant-val" style="color:#dc2626">${fmt(budgetRestant)}</div><div class="bgt-restant-sub" style="color:#7f1d1d">Ce montant sera <strong>dÃ©finitivement perdu en ${EXPIRY_DATE}</strong> si vous ne l'utilisez pas.</div></div>`;
  } else {
    document.getElementById('resBgtRestant').innerHTML='';
  }
  confetti();
  sendEmails({pre,nom,email,civ:gv('c_civ'),phone:gv('c_phone'),etab:S.etab,act,opco,opcoName,totalCost,finOpco,rac,budgetRestant,rows,nb});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EMAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendEmails(d){
  const now=new Date().toLocaleDateString('fr-FR',{day:'2-digit',month:'long',year:'numeric'});
  const actLabel=CFG[d.act]?.label||d.act;
  const titre=d.civ==='M.'?'Monsieur':'Madame';
  const fRows=d.rows.map(({f,h,cost})=>`<tr style="border-bottom:1px solid #f3f4f6"><td style="padding:9px 12px;font-size:13px">${f.nm}</td><td style="padding:9px 8px;text-align:center;font-size:13px">${h}h</td><td style="padding:9px 12px;text-align:right;font-size:13px;font-weight:700">${fmtN(cost)} â‚¬</td></tr>`).join('');
  const pecBg=d.rac===0?'#d1fae5':'#fef3c7';const pecBd=d.rac===0?'#10b981':'#f59e0b';
  const pecTxt=d.rac===0?'âœ… Prise en charge potentielle Ã  100% â€” 0 â‚¬ de reste Ã  charge':`âš ï¸ Reste Ã  charge estimÃ© : ${fmtN(d.rac)} â‚¬`;
  const bgtRestantBlock=d.budgetRestant>0
    ?`<div style="background:#fef2f2;border:2px solid #fca5a5;padding:16px;text-align:center;margin-bottom:16px"><div style="font-size:12px;font-weight:700;color:#991b1b">âš ï¸ BUDGET OPCO NON UTILISÃ‰</div><div style="font-size:24px;font-weight:800;color:#dc2626;margin:6px 0">${fmtN(d.budgetRestant)} â‚¬</div><div style="font-size:11px;color:#7f1d1d">Ce montant sera <strong>dÃ©finitivement perdu en ${EXPIRY_DATE}</strong>.</div></div>`
    :`<div style="background:#d1fae5;border:2px solid #10b981;padding:12px;text-align:center;margin-bottom:16px;font-size:13px;font-weight:700;color:#065f46">âœ… Vous mobilisez 100% de votre budget OPCO !</div>`;

  const prospectHtml=`<!DOCTYPE html><html><head><meta charset="UTF-8"></head>
<body style="margin:0;padding:0;background:#f0f8f6;font-family:Arial,Helvetica,sans-serif">
<table width="100%" cellpadding="0" cellspacing="0"><tr><td align="center" style="padding:24px 16px">
<table width="600" cellpadding="0" cellspacing="0" style="background:#fff;max-width:600px;width:100%;border:1px solid #e5e7eb">
<tr><td style="background:#2b4d3f;padding:32px 28px;text-align:center">
  <img src="https://image2url.com/r2/default/images/1769773980533-eefb09b4-6364-4787-a446-f57abf702834.png" width="180" style="display:block;margin:0 auto 14px">
  <div style="display:inline-block;border:1px solid rgba(255,255,255,.4);padding:8px 20px;font-size:12px;font-weight:700;color:#fff;letter-spacing:1px;text-transform:uppercase">Votre analyse personnalisÃ©e</div>
</td></tr>
<tr><td style="padding:28px 28px">
  <p style="font-size:15px;font-weight:700;color:#1a2e23;margin-bottom:8px">${titre} ${d.nom},</p>
  <p style="font-size:14px;line-height:1.7;color:#374151;margin-bottom:22px">Suite Ã  votre simulation, voici le rÃ©capitulatif de votre <strong>financement formation</strong>. Lab Learning est Ã  vos cÃ´tÃ©s pour sÃ©curiser votre structure et optimiser vos rÃ©sultats.</p>
  <table width="100%" cellpadding="0" cellspacing="0" style="background:#f9fafb;margin-bottom:18px">
    <tr><td style="padding:10px 14px;font-size:12px;color:#374151"><strong>ActivitÃ© :</strong> ${actLabel}</td><td style="padding:10px 14px;font-size:12px;color:#374151"><strong>OPCO :</strong> ${d.opcoName}</td></tr>
    <tr><td style="padding:10px 14px;font-size:12px;color:#374151"><strong>Ã‰tablissement :</strong> ${d.etab||'â€”'}</td><td style="padding:10px 14px;font-size:12px;color:#374151"><strong>SalariÃ©s :</strong> ${d.nb}</td></tr>
  </table>
  <div style="background:#e4f3ea;border:2px solid #8fc9a6;padding:14px;text-align:center;margin-bottom:16px">
    <div style="font-size:12px;font-weight:700;color:#1a5c35;text-transform:uppercase;letter-spacing:1px">Votre budget OPCO disponible</div>
    <div style="font-size:28px;font-weight:800;color:#2b4d3f;margin-top:4px">${fmtN(d.opco)} â‚¬</div>
  </div>
  <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid #e5e7eb;margin-bottom:16px">
    <thead><tr style="background:#2b4d3f"><th style="padding:10px 12px;text-align:left;color:#fff;font-size:10px;font-weight:700;text-transform:uppercase">Formation</th><th style="padding:10px 8px;text-align:center;color:#fff;font-size:10px;font-weight:700;text-transform:uppercase">DurÃ©e</th><th style="padding:10px 12px;text-align:right;color:#fff;font-size:10px;font-weight:700;text-transform:uppercase">Montant</th></tr></thead>
    <tbody>${fRows}</tbody>
    <tfoot><tr style="background:#f9fafb"><td colspan="2" style="padding:12px;font-weight:800;font-size:13px">Total estimÃ©</td><td style="padding:12px;text-align:right;font-weight:800;font-size:15px;color:#2b4d3f">${fmtN(d.totalCost)} â‚¬</td></tr></tfoot>
  </table>
  <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid #e5e7eb;margin-bottom:16px">
    <tr style="background:#f9fafb"><td style="padding:10px 14px;font-size:13px">Budget ${d.opcoName} disponible</td><td style="padding:10px 14px;text-align:right;font-size:13px;font-weight:700;color:#2b4d3f">${fmtN(d.opco)} â‚¬</td></tr>
    <tr><td style="padding:12px 14px;font-size:14px;font-weight:800;border-top:2px solid #2b4d3f">Reste Ã  charge estimÃ©</td><td style="padding:12px 14px;text-align:right;font-size:16px;font-weight:800;color:${d.rac===0?'#3a8a5c':'#c53030'};border-top:2px solid #2b4d3f">${fmtN(d.rac)} â‚¬</td></tr>
  </table>
  <div style="background:${pecBg};border:2px solid ${pecBd};padding:12px;text-align:center;margin-bottom:16px;font-size:13px;font-weight:800;color:${d.rac===0?'#1a5c35':'#7a5a0b'}">${pecTxt}</div>
  ${bgtRestantBlock}
  <div style="background:#e4f3ea;padding:18px;text-align:center">
    <div style="font-size:14px;font-weight:800;color:#2b4d3f;margin-bottom:10px">Besoin d'un accompagnement ?</div>
    <div style="font-size:13px;color:#374151;margin-bottom:4px">ğŸ“ <a href="tel:+33626835580" style="color:#2b4d3f;font-weight:700;text-decoration:none">06 26 83 55 80</a></div>
    <div style="font-size:13px;color:#374151">âœ‰ï¸ <a href="mailto:laoussine.tatah@lab-learning.fr" style="color:#2b4d3f;font-weight:700;text-decoration:none">laoussine.tatah@lab-learning.fr</a></div>
  </div>
  <div style="margin-top:14px;padding:10px 14px;background:#fdf8e8;font-size:11px;color:#6b4e0a">âš ï¸ Estimation indicative. Montants confirmÃ©s aprÃ¨s analyse de votre dossier.</div>
</td></tr>
<tr><td style="background:#2b4d3f;padding:16px 28px;text-align:center;font-size:11px;color:rgba(255,255,255,.55)">Lab Learning â€” Organisme de formation professionnelle continue</td></tr>
</table></td></tr></table></body></html>`;

  const internalHtml=`<!DOCTYPE html><html><head><meta charset="UTF-8"></head>
<body style="font-family:Arial,sans-serif;padding:24px;color:#1a1a1a">
<h2 style="color:#2b4d3f">ğŸ”” Nouveau prospect â€” Simulateur en ligne</h2>
<table style="border-collapse:collapse;width:100%;max-width:560px">
${[['Nom',`${d.civ} ${d.pre} ${d.nom}`],['Email',`<a href="mailto:${d.email}">${d.email}</a>`],['TÃ©lÃ©phone',`<a href="tel:${d.phone}">${d.phone}</a>`],['Ã‰tablissement',d.etab||'â€”'],['ActivitÃ©',`${actLabel} (${d.opcoName})`],['SalariÃ©s',d.nb],['Budget OPCO',`${fmtN(d.opco)} â‚¬`],['Total sÃ©lectionnÃ©',`<strong>${fmtN(d.totalCost)} â‚¬</strong>`],['Pris en charge',`<strong style="color:#3a8a5c">${fmtN(d.finOpco)} â‚¬</strong>`],['Reste Ã  charge',`<strong style="color:${d.rac===0?'#3a8a5c':'#c53030'}">${fmtN(d.rac)} â‚¬</strong>`],['â­ Budget restant',`<strong style="color:${d.budgetRestant>0?'#c53030':'#3a8a5c'}">${fmtN(d.budgetRestant)} â‚¬ ${d.budgetRestant>0?'â€” expire '+EXPIRY_DATE:'â€” 100% mobilisÃ© âœ…'}</strong>`]].map(([k,v])=>`<tr><td style="padding:8px;background:#eef2ef;font-weight:700;border:1px solid #ddd">${k}</td><td style="padding:8px;border:1px solid #ddd">${v}</td></tr>`).join('')}
</table>
<h3 style="margin-top:18px">Formations :</h3>
<ul>${d.rows.map(({f,h,cost})=>`<li>${f.nm} (${h}h) â€” ${fmtN(cost)} â‚¬</li>`).join('')}</ul>
<hr><p style="color:#5f7368;font-size:11px">Simulateur public Lab Learning â€” ${now}</p>
</body></html>`;

  let errors=[];
  try{
    const r1=await fetch(EMAIL_PROXY,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sender:SENDER,to:[{email:d.email,name:`${d.pre} ${d.nom}`}],subject:`Votre analyse de formation personnalisÃ©e â€” Lab Learning`,htmlContent:prospectHtml})});
    if(!r1.ok){const t=await r1.text();errors.push('Prospect: '+r1.status+' '+t);}
  }catch(e){errors.push('Prospect: '+e.message);}
  try{
    const r2=await fetch(EMAIL_PROXY,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sender:SENDER,to:[{email:SENDER.email}],subject:`ğŸ”” Prospect: ${d.pre} ${d.nom} â€” ${actLabel} â€” ${fmtN(d.totalCost)}â‚¬ â€” Restant: ${fmtN(d.budgetRestant)}â‚¬`,htmlContent:internalHtml})});
    if(!r2.ok){const t=await r2.text();errors.push('Interne: '+r2.status+' '+t);}
  }catch(e){errors.push('Interne: '+e.message);}
  if(errors.length===0){toast('âœ… Analyse envoyÃ©e par email !','ok');}
  else{console.error('Email errors:',errors);toast('âš ï¸ Erreur envoi email â€” rÃ©sultat affichÃ© ci-dessous','err');}
  document.getElementById('btnSubmit').classList.remove('btn-loading');document.getElementById('btnSubmit').textContent='Recevoir mon analyse complÃ¨te par email';
}

function toast(msg,type='ok'){const t=document.getElementById('sw-toast');t.textContent=msg;t.className=`show t-${type}`;setTimeout(()=>t.className='',3500);}
function confetti(){const colors=['#6bc88d','#2b4d3f','#a8e0be','#e8a020','#3a8a5c'];for(let i=0;i<18;i++){const d=document.createElement('div');d.className='c-dot';d.style.cssText=`left:${20+Math.random()*60}%;top:${30+Math.random()*15}%;background:${colors[i%colors.length]};animation-delay:${Math.random()*.5}s;animation-duration:${1.3+Math.random()*.8}s`;document.body.appendChild(d);setTimeout(()=>d.remove(),2500);}}

renderActGrid();renderProg();
document.getElementById('expiryYearPromise').textContent=EXPIRY_YEAR;
</script>
</body>
</html>
